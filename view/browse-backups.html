<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Browse Backups</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <link href="jquery-ui-1.11.0/jquery-ui.css" rel="stylesheet">
        <link href="jstree/dist/themes/default/style.css" rel="stylesheet">
        <link href="jqGrid/css/ui.jqgrid.css" rel="stylesheet">
    </head>
    <body>

        <div id="login">
            <input id="username" type="text" /> 
            <input id="password" type="password" /> 
            <button id="loginbutton">Login</button> 
        </div>
        <div id="logout" style="display: none">
            <button id="logoutbutton">Logout</button>
        </div>

        <div id="dialog-ajax-error" title="Error">
            <p>The following error occured:</p>
            <pre id="dialog-ajax-error-msg"></pre>
        </div>

        <div style="overflow: hidden; padding: 20px">
            <div id="treeview"  style="float: left"></div>
            <div style="float: left; padding-left: 50px" id="currentcontent">
                <div id="backupcontent-app" class="backupcontent backupcontent-app" style="display: none">
                    <h1>App</h1>
                    <table id="content-app"></table>
                    <div id="content-app-pager"></div> 
                </div>
                <div id="backupcontent-org" class="backupcontent backupcontent-org" style="display: none">
                    <h1>Organization</h1>
                </div>
                <div id="backupcontent-space" class="backupcontent backupcontent-space" style="display: none">
                    <h1>Space</h1>
                </div>
                <div id="backupcontent-backupiteration" class="backupcontent backupcontent-backupiteration" style="display: none">
                    <h1>Backup Iteration</h1>
                </div>
                <div id="backupcontent-backupcollection" class="backupcontent backupcontent-backupcollection" style="display: none">
                    <h1>Backup</h1>
                </div>
                <div id="backupcontent-start" class="backupcontent backupcontent-start">
                    <h1>Welcome</h1>
                    <p>Browse backups in navigation.</p>
                </div>
            </div>
        </div>
        <div id="results"><b>Results</b><br></div>
        <pre id="jsonoutput"></pre>

        <script src="jquery-ui-1.11.0/external/jquery/jquery.js"></script>
        <script src="jquery-ui-1.11.0/jquery-ui.js"></script>
        <script src="jstree/dist/jstree.js"></script>
        <script src="jquery.cookie-1.4.1.min.js"></script>
        <script src="jqGrid/js/i18n/grid.locale-en.js"></script>
        <script src="jqGrid/js/jquery.jqGrid.src.js"></script>

        <script>

            jQuery(document).ready(function() {

                var logincookie = $.cookie('podio_backup_login_session');
                if (typeof logincookie !== 'undefined') {
                    loginsession = logincookie;
                    $('#login').hide();
                    $('#logout').hide();
                    $.ajax({
                        url: '../login',
                        success: function(msg) {
                            $('#logout').show();
                        },
                        error: function(msg) {
                            console.log('auto login error');
                            console.log(loginsession);
                            console.log(msg);
                            $('#login').show();
                        }
                    })
                }

                var types = ['backupcollection', 'backupiteration', 'org', 'space', 'app'/*, 'item'*/];

                var jstree = $('#treeview').jstree({
                    'core': {
                        "check_callback": true //allow manual node add/remove!
                    }
                });

                console.log('created tree: ' + jstree);

                $('#treeview').on("changed.jstree", function(e, data) {
                    console.log("changed.jstree");
                    console.log(data.selected);
                    console.log(e);
                });

                $('#treeview').on('select_node.jstree', function(e, data) {
                    console.log('select_node');
                    console.log(data);
                    $('.backupcontent').hide();
                    switch (data.node.data.type) {
                        case 0:
                            $('#backupcontent-start').show();
                            break;
                        case 1:
                            $('#backupcontent-backupcollection').show();
                            break;
                        case 2:
                            $('#backupcontent-backupiteration').show();
                            break;
                        case 3:
                            $('#backupcontent-org').show();
                            break;
                        case 4:
                            $('#backupcontent-space').show();
                            break;
                        case 5:
                            $('#backupcontent-app').show();

                            $("#content-app").jqGrid({
                                datatype: function(postdata) {
                                    console.log('loading grid:');
                                    console.log(postdata);
                                    var thegrid = $("#content-app")/*[0]*/;
                                    for (i = 0; i < 20; i++) {


                                        thegrid.addRowData("1" + i, {
                                            podioid: "my-podio-id-" + i,
                                            title: "my-title"
                                        });
                                    }
                                    thegrid.setGridParam({lastpage: 40})/*.trigger("reloadGrid") CAUSES ENDLESS LOOP!*/;
                                    console.log('using url: ' + data.node.data.url);
                                    $.ajax({
                                        url: data.node.data.url,
                                        data: {start: 0, count: 10},
                                        success: function(msg) {
                                            //thegrid.addXmlData(xmldata.responseXML);
                                            console.log('fetched table content');
                                            console.log(msg);
                                            $('#jsonoutput').text(msg);
                                        }
                                    });
                                },
                                colNames: ['Podio ID', 'Title'],
                                colModel: [
                                    {name: 'podioid', index: 'podioid'/*, width: 55*/},
                                    {name: 'title', index: 'title'/*, width: 90*/},
                                ],
                                pager: '#content-app-pager',
                                rowNum: 10,
                                rowList: [10, 20, 30],
                                viewrecords: true,
                                caption: 'My first grid'
                            });
                            break;
                        default :
                            console.warn('unexpected type: ' + data.node.data.type)
                            $('#backupcontent-start').show();
                    }
                });

                $(document).ajaxSend(function(event, jqXHR, ajaxOptions) {
                    if (typeof loginsession !== 'undefined') {
                        jqXHR.setRequestHeader('PhpBackupLoginSession', loginsession);
                        console.log('using login session:');
                        console.log(loginsession);
                    } else if (typeof currentuser !== 'undefined') {
                        jqXHR.setRequestHeader('Authorization', 'Basic ' + window.btoa(currentuser + ':' + currentpassword));
                    } else {
                        console.log('no login information found.');
                    }
                });

                $.ajaxPrefilter(function(options) {
                    console.log('ajaxPrefilter');
                    console.log(options);
                    options.error = function(msg) {
                        console.log('error on ajax call:');
                        console.log(msg);
                        $('#dialog-ajax-error-msg').text(msg['responseText']);
                        $('#dialog-ajax-error').dialog('open');
                    };

                });

                $('#treeview').on('open_node.jstree', function(e, data) {
                    console.log('opend node');
                    console.log(data);
                    if (data.node.data.expanded === false) {
                        console.log('expanding new node..');
                        $.ajax({
                            url: data.node.data.url,
                            success: function(msg) {
                                //todo remove loading..
                                $('#treeview').jstree(true).delete_node(data.node.children[0]);
                                data.node.data.expanded = true;

                                var nexttype = types[data.node.data.type + 1];
                                if (typeof nexttype === 'undefined') {
                                    nexttype = 'item';
                                }
                                for (i in msg) {
                                    $("#results").append("item: " + msg[i].toString() + "<br>");
                                    var node = $('#treeview').jstree(true).create_node(data.node, msg[i]);
                                    $('#treeview').jstree(true).get_node(node).data = {
                                        expanded: false,
                                        type: data.node.data.type + 1,
                                        url: data.node.data.url + '/' + msg[i].toString() + '/' + nexttype
                                    };
                                    if (types.length > data.node.data.type + 1) {
                                        $('#treeview').jstree(true).create_node(node, 'loading..');
                                    } else {
                                        console.log('dont add loading child to last leaf..')
                                        console.log(types);
                                        console.log(types.length);
                                        console.log(data.node.data.type);
                                        console.log(data.node.data.type + 2);
                                    }
                                }
                            }
                        })
                    }
                });

                $("#dialog-ajax-error").dialog({
                    autoOpen: false,
                    width: 400,
                    buttons: [
                        {
                            text: "Ok",
                            click: function() {
                                $(this).dialog("close");
                            }
                        }
                    ]
                });

                $("#dialog-error").dialog({
                    autoOpen: false,
                    width: 400,
                    buttons: [
                        {
                            text: "Ok",
                            click: function() {
                                $(this).dialog("close");
                            }
                        }
                    ]
                });

                $('#logoutbutton').on('click', function(e, data) {
                    $.ajax({
                        url: '../logout',
                        success: function(msg) {
                            $('#login').show('slow');
                            $('#logout').hide('slow');
                            $.removeCookie('podio_backup_login_session', {path: '/'});
                            location.reload();
                        }
                    });
                });

                $('#loginbutton').on('click', function(e, data) {
                    var user = $('#username').val();
                    var password = $('#password').val();
                    $.ajax({
                        url: '../login',
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader('Authorization', 'Basic ' + window.btoa(user + ':' + password));
                        },
                        success: function(msg) {
                            $('#login').hide('slow');
                            $('#logout').show('slow');
                            console.log('login successfull');
                            console.log(msg);
                            currentuser = user;
                            currentpassword = password;
                            loginsession = msg['loginsession'];
                            $.cookie('podio_backup_login_session', msg['loginsession'], {expires: 7, path: '/'});
                            console.log('stored login session in cookie');
                            console.log(msg['loginsession']);
                        }

                    });
                });

                $('#treeview').on('create_node.jstree', function(e, data) {
                    console.log('created node: ' + data.node.text);
                });

                var rootnode = $('#treeview').jstree(true).create_node('#', 'All visible Backups');
                $('#treeview').jstree(true).get_node(rootnode).data = {
                    expanded: false,
                    type: 0,
                    url: '../' + types[0]
                };
                $('#treeview').jstree(true).create_node(rootnode, 'loading..');

            });



        </script>
    </body>
</html>
